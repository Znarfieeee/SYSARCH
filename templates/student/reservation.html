{% extends 'home.html'%}
{% block content %}
<div id="main-container" class="flex flex-row justify-center min-h-screen py-10 gap-4 mx-auto">

    <div id="calendar-container" class="bg-white p-8 rise-up rounded-md shadow-md w-[65%] h-155">
        <div id="header" class="flex justify-between items-center mb-4">
            <button id="previous" class="text-gray-600 hover:text-black"><i class="fas fa-chevron-left cursor-pointer size-10"></i></button>
            <div id="current-month-year" class="text-lg font-bold"></div>
            <button id="next" class="text-gray-600 hover:text-black"><i class="fas fa-chevron-right cursor-pointer size-10"></i></button>
        </div>
        <div id="days" class="grid grid-cols-7 text-center font-bold mb-2">
            <p>Sun</p> 
            <p>Mon</p> 
            <p>Tue</p> 
            <p>Wed</p> 
            <p>Thu</p> 
            <p>Fri</p> 
            <p>Sat</p>
        </div>
        <div id="dates" class="grid grid-cols-7 gap-4"></div>
    </div>
    <div id="schedule-container" class="flex flex-col rise-up bg-white p-6 rounded-lg shadow-md w-[300px] min-h-[150px] max-h-155 overflow-hidden">
        <h1 class="mt-3 font-bold text-lg">Schedule</h1>
        <hr class="py-px mt-4">
        <div id="schedule-table" class="space-y-2 h-full overflow-y-auto">
            <!-- Table will be dynamically populated -->
        </div>
    </div>
</div>

<!-- Reservation Modal -->
<div id="modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-999 flex justify-center items-center transition-all duration-300">
    <div id="modalContent" class="bg-gray-200 shadow-md p-10 rounded-lg w-[500px] transform scale-20 opacity-0 transition-all duration-300">
        <form action="/book" method="post" name="reservation-form"> 
            <input type="hidden" id="selectedDate" name="date">
            <h1 class="font-bold text-2xl text-center">Reservation</h1>
            <h2 id="thisday" class="text-lg text-center mb-8"></h2>
            <div id="reserve-container" class="flex flex-col gap-4 w-[90%] mx-auto">
                <div id="purpose-container">
                    <label for="purpose" class="block text-gray-700 font-semibold text-base mb-2">Purpose:</label>
                    <select id="purpose" name="purpose" class="w-full border-b-2 border-gray-500 focus:outline-none focus:border-blue-500 p-2 mb-4">
                        <option value="" disabled selected>Select a Purpose</option>
                        <option value="Java programming">Java Programming</option>
                        <option value="C programming">C Programming</option>
                        <option value="C# programming">C# Programming</option>
                        <option value="Php programming">Php Programming</option>
                        <option value="Python programming">Python Programming</option>
                        <option value="Javascript programming">Javascript Programming</option>
                        <option value="ASP.Net programming">ASP.Net Programming</option>
                    </select>
                </div>
                <div id="lab-no-container">
                    <label for="labno" class="block text-gray-700 font-semibold text-base mb-2">Lab:</label>
                    <select id="labno" name="labno" class="w-full border-b-2 border-gray-500 focus:outline-none focus:border-blue-500 p-2 mb-4">
                        <option value="" disabled selected>Select Laboratory</option>
                        <option value="542">542</option>
                        <option value="524">524</option>
                        <option value="526">526</option>
                        <option value="528">528</option>
                        <option value="530">530</option>
                        <option value="Mac Laboratory">Mac Laboratory</option>
                    </select>
                </div>
                <div id="time-slot-container">
                    <label for="timeSlot" class="block text-gray-700 font-semibold text-base mb-2">Time Slot:</label>
                    <div id="timeSlot" class="flex justify-between gap-4">
                        <input class="w-full border-b-2 border-gray-500 focus:outline-none focus:border-blue-500 p-2" type="time" name="time-start">
                        <input class="w-full border-b-2 border-gray-500 focus:outline-none focus:border-blue-500 p-2" type="time" name="time-end">
                    </div>
                </div>
                <div id="action-btn-container" class="flex justify-between mt-6 gap-2">
                    <button id="close-btn" type="button" onclick="closeModal()" class="bg-red-500 hover:bg-red-700 text-white p-2 rounded-lg h-10 w-20 cursor-pointer transition ease-in-out duration-500 shadow-xl hover:shadow-red-500/50">Cancel</button>
                    <button id="save-btn" type="submit" class="bg-blue-500 hover:bg-blue-700 text-white p-2 rounded-lg h-10 w-20 cursor-pointer transition ease-in-out duration-500 shadow-xl hover:shadow-indigo-500/50">Reserve</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Edit Reservation Modal -->
<div id="editReservationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <h3 class="text-lg leading-6 font-medium text-gray-900">Edit Reservation</h3>
            <div class="mt-2">
                <form id="editReservationForm">
                    <input type="hidden" id="reservationId" name="reservationId">
                    <div class="mb-4">
                        <label for="editDate" class="block text-sm font-medium text-gray-700">Date</label>
                        <input type="date" id="editDate" name="date" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="mb-4">
                        <label for="editTimeStart" class="block text-sm font-medium text-gray-700">Start Time</label>
                        <input type="time" id="editTimeStart" name="time_start" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="mb-4">
                        <label for="editTimeEnd" class="block text-sm font-medium text-gray-700">End Time</label>
                        <input type="time" id="editTimeEnd" name="time_end" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="mb-4">
                        <label for="editLabNo" class="block text-sm font-medium text-gray-700">Lab Number</label>
                        <input type="text" id="editLabNo" name="labno" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="mb-4">
                        <label for="editPurpose" class="block text-sm font-medium text-gray-700">Purpose</label>
                        <input type="text" id="editPurpose" name="purpose" class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div class="flex justify-end">
                        <button type="button" onclick="closeEditModal()" class="bg-gray-500 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded mr-2">Cancel</button>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    const monthYear = document.getElementById('current-month-year');
    const datesContainer = document.getElementById('dates');
    const prevBtn = document.getElementById('previous');
    const nextBtn = document.getElementById('next');
    const modal = document.getElementById('modal')
    const dateElement = document.getElementById('thisday');
    let currentDate = new Date();
    const modalContent = document.getElementById('modalContent');

    function generateCalendar(date) {
        datesContainer.innerHTML = '';
        const year = date.getFullYear();
        const month = date.getMonth();
        monthYear.textContent = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(date);
        
        const firstDay = new Date(year, month, 1).getDay();
        const lastDate = new Date(year, month + 1, 0).getDate();
        
        for (let i = 0; i < firstDay; i++) {
            datesContainer.innerHTML += '<div></div>'; // Empty spaces
        }
        
        for (let day = 1; day <= lastDate; day++) {
            const dateElem = document.createElement('div');
            dateElem.textContent = day;
            dateElem.className = "flex justify-center items-center cursor-pointer p-2 rounded hover:bg-gray-100 rounded-full hover:ring hover:ring-gray-500 hover:shadow-md size-17 mx-auto duration-500 hover:-translate-y-1.5 ease-in-out delay-20";
            dateElem.setAttribute('name', 'today')
            dateElem.addEventListener('click', () => {
                const monthName = new Date(year, month).toLocaleString('en-US', { month: 'short' });
                modal.classList.toggle('hidden')
                setTimeout(() => {
                    modalContent.classList.remove('scale-20', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 100);

                dateElement.textContent = `Selected Date: ${ monthName } ${day} ${year}`;
                document.getElementById('selectedDate').value = `${year} ${String(monthName)} ${String(day).padStart(2, '0')}`;
            });
            datesContainer.appendChild(dateElem);
        }
    }
    
    // Previous Button Event Listener
    prevBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() - 1);
        generateCalendar(currentDate);
    });

    // Next Button Event Listener
    nextBtn.addEventListener('click', () => {
        currentDate.setMonth(currentDate.getMonth() + 1);
        generateCalendar(currentDate);
    });

    // Close Modal
    function closeModal() {
        modalContent.classList.remove('scale-100', 'opacity-100');
        modalContent.classList.add('scale-20', 'opacity-0');
        setTimeout(() => {
            modal.classList.toggle('hidden');
        }, 300);
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        fetch('/get_reservations')
        .then(response => response.json())
        .then(data => {
            const scheduleTable = document.getElementById('schedule-table');
            scheduleTable.innerHTML = '';

            data.forEach(reservation => {
                let statusClass = '';
                if (reservation.status === 'approved') {
                    statusClass = 'status-approved';
                } else if (reservation.status === 'pending') {
                    statusClass = 'status-pending';
                } else if (reservation.status === 'denied') {
                    statusClass = 'status-denied';
                }
                const reservationCard = `

                        <div id="reservation-card" class="p-4 hover:-translate-y-1.5 duration-300 hover:shadow-md border-l-4 border-gray-400 rounded-xl cursor-pointer">
                            <div class="flex  justify-between">
                                <span class="font-bold">${reservation.date}</span>
                                <span class="text-sm ${statusClass}">${reservation.status}</span>    
                            </div>    
                            <div class="text-sm text-gray-700 mt-2"> 
                                <span>${reservation.purpose}</span>
                            </div>
                            <div class="flex justify-between mt-2 text-sm text-gray-600">
                                <span>ðŸ•’ ${reservation.time_start}</span>
                                <span>ðŸ•’ ${reservation.time_end}</span>
                            </div>
                            <div class="mt-2 text-sm font-semibold">Lab: ${reservation.labno}</div>
                        </div> 

                `;
                scheduleTable.innerHTML += reservationCard;
            })
        })
        .catch(error => console.error('Error fetching data:', error));
    })

    generateCalendar(currentDate);

    function openEditModal(reservation) {
        document.getElementById('reservationId').value = reservation.id;
        document.getElementById('editDate').value = reservation.date;
        document.getElementById('editTimeStart').value = reservation.time_start;
        document.getElementById('editTimeEnd').value = reservation.time_end;
        document.getElementById('editLabNo').value = reservation.labno;
        document.getElementById('editPurpose').value = reservation.purpose;
        document.getElementById('editReservationModal').classList.remove('hidden');
    }

    function closeEditModal() {
        document.getElementById('editReservationModal').classList.add('hidden');
    }

    document.getElementById('editReservationForm').addEventListener('submit', async function(event) {
        event.preventDefault();
        const formData = new FormData(this);
        const reservationId = formData.get('reservationId');

        try {
            const response = await fetch(`/api/reservation/${reservationId}/edit`, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (response.ok) {
                alert('Reservation updated successfully');
                window.location.reload();
            } else {
                throw new Error(result.error || 'Failed to update reservation');
            }
        } catch (error) {
            console.error('Error:', error);
            alert(error.message);
        }
    });
</script>
{% endblock %}