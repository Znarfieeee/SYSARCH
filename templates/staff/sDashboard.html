{% extends 'staff.html'%} {% block content %}
<div
    id="main-container"
    class="grid grid-cols-10 grid-rows-6 gap-4 py-10 px-20 h-[90vh]">
    <!-- Statistics Data -->
    <div
        id="container-1"
        class="col-span-6 row-span-6 grid gap-4 grid-rows-20 rounded-md">
        <div id="box1" class="row-span-5 grid grid-cols-4 gap-4 rise-up">
            <div
                id="registered-student"
                class="flex flex-col justify-between bg-white shadow-md align- p-4 rounded-lg hover:-translate-y-1.5 transition duration-300 ease-in-out delay-50 cursor-pointer"
                onclick="window.location.href='/staff/students'">
                <p class="text-gray-600 font-medium">Registered Students</p>
                <span
                    id="totalRegStuds"
                    class="flex justify-center text-6xl text-blue-600">
                    {{ total_registered_students }}
                </span>
            </div>
            <div
                id="current-sitin"
                class="flex flex-col justify-between bg-white shadow-md align- p-4 rounded-lg hover:-translate-y-1.5 transition duration-300 ease-in-out delay-50 cursor-pointer"
                onclick="window.location.href='/staff/students/current'">
                <p class="text-gray-600 font-medium">Currently Sit-in</p>
                <span
                    id="curSitIn"
                    class="flex justify-center text-6xl text-green-600">
                    {{ currently_sit_in }}
                </span>
            </div>
            <div
                id="reservation-count"
                class="flex flex-col justify-between bg-white shadow-md p-4 align- rounded-lg cursor-pointer hover:-translate-y-1.5 transition duration-300 ease-in-out delay-50"
                onclick="window.location.href='/staff/students/pending'">
                <p class="text-gray-600 font-medium">Pending Reservations</p>
                <span
                    id="reservationCount"
                    class="flex justify-center text-6xl text-red-600"></span>
            </div>
            <div
                id="total-sitin"
                class="flex flex-col justify-between bg-white shadow-md p-4 align- rounded-lg hover:-translate-y-1.5 transition duration-300 ease-in-out delay-50 cursor-pointer"
                onclick="window.location.href='/staff/students/total'">
                <p class="text-gray-600 font-medium">Total Sit-in</p>
                <span
                    id="totalSitIn"
                    class="flex justify-center text-6xl text-purple-600">
                    {{ total_sit_in }}
                </span>
            </div>
        </div>
        <div class="flex flex-row row-span-15 gap-4">
            <div
                id="box2"
                class="flex flex-col p-4 py-3 bg-white shadow-md text-xs rounded-lg rise-up w-2/3 transition-all duration-300 hover:shadow-lg">
                <div class="flex justify-between items-center mb-3">
                    <div>
                        <h3 class="font-semibold text-base text-gray-800">
                            Reservations by Purpose
                        </h3>
                        <p class="text-xs text-gray-500">
                            Distribution of student laboratory usage
                        </p>
                    </div>
                    <div class="flex items-center">
                        <div class="relative group">
                            <svg
                                class="w-4 h-4 text-gray-400 cursor-pointer hover:text-blue-500"
                                fill="none"
                                stroke="currentColor"
                                viewBox="0 0 24 24">
                                <path
                                    stroke-linecap="round"
                                    stroke-linejoin="round"
                                    stroke-width="2"
                                    d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div
                                class="absolute right-0 w-64 p-2 bg-white rounded shadow-lg opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200 z-10 text-xs">
                                This chart shows how students are using the
                                laboratory facilities across different purposes.
                            </div>
                        </div>
                    </div>
                </div>
                <div
                    id="chart-container"
                    class="flex justify-center w-full h-[80%] mt-2">
                    <canvas id="myChart" class="w-full"></canvas>
                </div>
                <div
                    id="no-data-message"
                    class="hidden flex-col items-center justify-center py-16 text-center">
                    <svg
                        class="w-12 h-12 text-gray-300 mb-3"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24">
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-gray-500 font-medium">
                        No reservation data available
                    </p>
                    <p class="text-xs text-gray-400 mt-1">
                        Data will appear when students make reservations
                    </p>
                </div>
            </div>
            <!-- Leaderboard Section -->
            <div
                id="leaderboard-container"
                class="bg-white shadow-md rounded-lg rise-up w-1/3 p-4 flex flex-col">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-semibold text-lg flex items-center">
                        <svg
                            class="w-5 h-5 text-yellow-500 mr-2"
                            fill="currentColor"
                            viewBox="0 0 24 24">
                            <path
                                d="M5 3h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2zm7 14c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm6-9h-3V6h-2v2H8V6H6v2H3v2h3.2c.4 1.9 2 3.3 4 3.3s3.6-1.4 4-3.3h3.8V8z" />
                        </svg>
                        <span class="text-gray-800">Top Students</span>
                    </h2>
                </div>
                <div class="flex p-1 bg-gray-100 rounded-lg">
                    <button
                        id="points-tab"
                        class="px-3 py-1.5 text-xs font-medium bg-blue-600 text-white rounded-md shadow-sm transition-all duration-200 transform hover:scale-105 leaderboard-tab active">
                        Points
                    </button>
                    <button
                        id="sitins-tab"
                        class="px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-200 rounded-md transition-all duration-200 transform hover:scale-105 leaderboard-tab">
                        Sit-ins
                    </button>
                    <button
                        id="percentage-tab"
                        class="px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-200 rounded-md transition-all duration-200 transform hover:scale-105 leaderboard-tab">
                        Rate
                    </button>
                </div>

                <div
                    class="bg-gradient-to-b from-blue-50 to-white rounded-lg p-3 mb-4 border border-blue-100">
                    <p
                        class="text-xs text-gray-600 text-center font-medium flex items-center justify-center">
                        <svg
                            class="w-3.5 h-3.5 text-blue-500 mr-1.5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24">
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Students with the highest achievements
                    </p>
                </div>

                <div
                    id="leaderboard-list"
                    class="flex-grow overflow-y-auto space-y-2.5 pr-1 leaderboard-scrollbar">
                    <div class="animate-pulse text-center text-gray-500 py-10">
                        <div class="inline-block">
                            <div
                                class="w-4 h-4 bg-blue-500 rounded-full animate-bounce"></div>
                            <div
                                class="w-4 h-4 bg-blue-500 rounded-full animate-bounce200"></div>
                            <div
                                class="w-4 h-4 bg-blue-500 rounded-full animate-bounce400"></div>
                        </div>
                        <p class="mt-2">Loading leaderboard...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Announcement -->
    <div
        id="container-2"
        class="col-span-4 row-span-6 w-full justify-center bg-white p-6 rounded-lg shadow-md overflow-hidden rise-up">
        <div id="header" class="flex justify-between">
            <h1 class="font-semibold text-xl py-auto p-2">Announcement</h1>
            <button
                id="toggleFormBtn"
                class="w-35 h-10 p-2 text-sm rounded-2xl cursor-pointer hover:bg-gray-500/50 hover:text-gray-50 hover:shadow-md transition ease-in-out duration-300">
                + Announcement
            </button>
        </div>
        <hr class="py-2" />
        <form
            id="announcementForm"
            onsubmit="handleFormSubmit(event)"
            class="relative mb-2 hidden opacity-0 translate-y-[-100px] shadow-sm duration-300 transition ease-in-out">
            <div
                id="announcement-form"
                class="bg-gray-100 shadow-sm rounded-lg p-4">
                <div class="input-group">
                    <input
                        required=""
                        type="text"
                        name="title"
                        autocomplete="off"
                        class="input w-full" />
                    <label class="user-label bg-gray-100">Title</label>
                </div>
                <div class="input-group py-4">
                    <textarea
                        required
                        name="content"
                        rows="4"
                        class="input w-full resize-none p-2"
                        style="min-height: 100px"></textarea>
                    <label class="user-label bg-gray-100">Content</label>
                </div>
                <div id="form-actions" class="flex justify-between pt-px">
                    <input type="hidden" name="announcement_id" value="" />
                    <button
                        type="button"
                        id="cancelBtn"
                        class="cursor-pointer hover:text-gray-200 transition duration-800 delay-300 w-20 h-10 bg-red-400 hover:bg-red-600 rounded-xl text-white">
                        Cancel
                    </button>
                    <button
                        type="submit"
                        class="cursor-pointer hover:text-gray-200 transition duration-300 w-20 h-10 bg-gray-500 hover:bg-gray-500/50 rounded-xl text-white">
                        Post
                    </button>
                </div>
            </div>
        </form>
        <div id="announcements-container" class="relative pb-6">
            {% for announcement in announcements %}
            <div
                class="bg-white shadow-md p-4 rounded-lg mb-4 border-l-4 border-gray-400">
                <div id="header" class="flex justify-between">
                    <h2 class="font-semibold text-xl">
                        {{ announcement.title }}
                    </h2>
                    <div class="action-btn flex gap-2">
                        <button class="editBtn" data-id="{{ announcement.id }}">
                            <svg height="1em" viewBox="0 0 512 512">
                                <path
                                    d="M410.3 231l11.3-11.3-33.9-33.9-62.1-62.1L291.7 89.8l-11.3 11.3-22.6 22.6L58.6 322.9c-10.4 10.4-18 23.3-22.2 37.4L1 480.7c-2.5 8.4-.2 17.5 6.1 23.7s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L387.7 253.7 410.3 231zM160 399.4l-9.1 22.7c-4 3.1-8.5 5.4-13.3 6.9L59.4 452l23-78.1c1.4-4.9 3.8-9.4 6.9-13.3l22.7-9.1v32c0 8.8 7.2 16 16 16h32zM362.7 18.7L348.3 33.2 325.7 55.8 314.3 67.1l33.9 33.9 62.1 62.1 33.9 33.9 11.3-11.3 22.6-22.6 14.5-14.5c25-25 25-65.5 0-90.5L453.3 18.7c-25-25-65.5-25-90.5 0zm-47.4 168l-144 144c-6.2 6.2-16.4 6.2-22.6 0s-6.2-16.4 0-22.6l144-144c6.2-6.2 16.4-6.2 22.6 0s6.2 16.4 0 22.6z"></path>
                            </svg>
                        </button>
                        <button
                            type="submit"
                            class="delete-button delay-50"
                            onclick="deleteAnnouncement('{{ announcement.id }}')">
                            <svg class="delete-svgIcon" viewBox="0 0 448 512">
                                <path
                                    d="M135.2 17.7L128 32H32C14.3 32 0 46.3 0 64S14.3 96 32 96H416c17.7 0 32-14.3 32-32s-14.3-32-32-32H320l-7.2-14.3C307.4 6.8 296.3 0 284.2 0H163.8c-12.1 0-23.2 6.8-28.6 17.7zM416 128H32L53.2 467c1.6 25.3 22.6 45 47.9 45H346.9c25.3 0 46.3-19.7 47.9-45L416 128z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <p class="text-sm text-gray-400 mb-4">
                    {{ announcement.created_at }}
                </p>
                <p class="text-sm line-clamp-1">{{ announcement.content }}</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        // Load statistics once
        fetch("/api/statistics")
            .then(response => response.json())
            .then(data => {
                document.getElementById("totalRegStuds").textContent =
                    data.total_registered_students
                document.getElementById("curSitIn").textContent =
                    data.currently_sit_in
                document.getElementById("totalSitIn").textContent =
                    data.total_sit_in
            })
            .catch(err => console.error("Error fetching statistics: ", err))

        // Load chart data once
        fetch("/statisticchart")
            .then(response => response.json())
            .then(data => {
                const chartContainer =
                    document.getElementById("chart-container")
                const noDataMessage = document.getElementById("no-data-message")

                if (!data || data.length === 0) {
                    chartContainer.classList.add("hidden")
                    noDataMessage.classList.remove("hidden")
                    noDataMessage.classList.add("flex")
                    return
                }

                const labels = data.map(item =>
                    item.purpose.replace(" programming", "")
                )
                const counts = data.map(item => item.count)

                // Enhanced color palette with matching border colors
                const backgroundColors = [
                    "rgba(54, 162, 235, 0.7)", // Blue
                    "rgba(255, 99, 132, 0.7)", // Pink
                    "rgba(255, 206, 86, 0.7)", // Yellow
                    "rgba(75, 192, 192, 0.7)", // Teal
                    "rgba(153, 102, 255, 0.7)", // Purple
                    "rgba(255, 159, 64, 0.7)", // Orange
                    "rgba(46, 204, 113, 0.7)", // Green
                    "rgba(236, 72, 153, 0.7)", // Hot pink
                    "rgba(45, 55, 72, 0.7)", // Dark blue
                    "rgba(214, 48, 49, 0.7)", // Red
                ]

                const borderColors = backgroundColors.map(color =>
                    color.replace("0.7)", "1)")
                )

                const ctx = document.getElementById("myChart").getContext("2d")
                const myChart = new Chart(ctx, {
                    type: "doughnut",
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: "Reservations by Purpose",
                                data: counts,
                                backgroundColor: backgroundColors,
                                borderColor: borderColors,
                                borderWidth: 2,
                                hoverOffset: 15,
                                borderRadius: 4,
                                spacing: 3,
                                hoverBorderWidth: 0,
                            },
                        ],
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: "60%",
                        plugins: {
                            legend: {
                                position: "bottom",
                                align: "start",
                                labels: {
                                    boxWidth: 8,
                                    boxHeight: 8,
                                    padding: 10,
                                    font: {
                                        size: 12,
                                        family: "'Inter', sans-serif",
                                    },
                                    usePointStyle: true,
                                    pointStyle: "circle",
                                    generateLabels: function (chart) {
                                        const original =
                                            Chart.overrides.pie.plugins.legend
                                                .labels.generateLabels
                                        const labels = original.call(
                                            this,
                                            chart
                                        )

                                        labels.forEach(label => {
                                            if (
                                                label.text &&
                                                label.text.length > 15
                                            ) {
                                                label.originalText = label.text
                                                label.text =
                                                    label.text.substring(
                                                        0,
                                                        12
                                                    ) + "..."
                                            }
                                        })

                                        return labels
                                    },
                                },
                                maxHeight: 100,
                                maxWidth: 300,
                                fullSize: false,
                                overflow: "wrap",
                                onHover: function (event, legendItem) {
                                    if (legendItem && legendItem.originalText) {
                                        document.getElementById(
                                            "myChart"
                                        ).style.cursor = "pointer"
                                    }
                                },
                                onLeave: function () {
                                    document.getElementById(
                                        "myChart"
                                    ).style.cursor = "default"
                                },
                            },
                            tooltip: {
                                backgroundColor: "rgba(255, 255, 255, 0.9)",
                                titleColor: "#1F2937",
                                bodyColor: "#4B5563",
                                bodyFont: {
                                    size: 11,
                                },
                                titleFont: {
                                    size: 12,
                                    weight: "bold",
                                },
                                padding: 12,
                                boxPadding: 6,
                                borderColor: "rgba(220, 220, 220, 1.0)",
                                borderWidth: 1,
                                displayColors: true,
                                boxWidth: 8,
                                boxHeight: 8,
                                usePointStyle: true,
                                callbacks: {
                                    title: function (context) {
                                        if (
                                            context[0].dataset.labels &&
                                            context[0].dataset.labels[
                                                context[0].dataIndex
                                            ]
                                        ) {
                                            return context[0].dataset.labels[
                                                context[0].dataIndex
                                            ]
                                        }
                                        return context[0].label || ""
                                    },
                                    label: function (context) {
                                        const value = context.raw || 0
                                        const total =
                                            context.dataset.data.reduce(
                                                (acc, val) => acc + val,
                                                0
                                            )
                                        const percentage =
                                            total > 0
                                                ? (
                                                      (value / total) *
                                                      100
                                                  ).toFixed(1) + "%"
                                                : "0%"
                                        return `${value} reservations (${percentage})`
                                    },
                                },
                            },
                        },
                        animation: {
                            animateScale: true,
                            animateRotate: true,
                            duration: 1000,
                            easing: "easeOutCubic",
                            delay: function (context) {
                                return context.dataIndex * 100
                            },
                        },
                    },
                })

                // Store the chart instance globally
                window.myChart = myChart
            })
            .catch(err => {
                console.error("Error fetching reservation statistics:", err)
                const chartContainer =
                    document.getElementById("chart-container")
                const noDataMessage = document.getElementById("no-data-message")

                chartContainer.classList.add("hidden")
                noDataMessage.classList.remove("hidden")
                noDataMessage.classList.add("flex")

                // Update the error message
                const iconElement = noDataMessage.querySelector("svg")
                iconElement.classList.remove("text-gray-300")
                iconElement.classList.add("text-red-300")

                const textElement =
                    noDataMessage.querySelector("p.text-gray-500")
                textElement.textContent = "Failed to load chart data"

                const subTextElement =
                    noDataMessage.querySelector("p.text-gray-400")
                subTextElement.textContent =
                    "Please refresh the page to try again"
            })

        // Load the initial leaderboard (points) once
        loadLeaderboard("points")

        // Set up tab switching
        document.querySelectorAll(".leaderboard-tab").forEach(tab => {
            tab.addEventListener("click", function () {
                // Remove active class from all tabs
                document.querySelectorAll(".leaderboard-tab").forEach(t => {
                    t.classList.remove("active", "bg-blue-600", "text-white")
                    t.classList.add("text-gray-700", "hover:bg-gray-200")
                })

                // Add active class to clicked tab
                this.classList.add("active", "bg-blue-600", "text-white")
                this.classList.remove("text-gray-700", "hover:bg-gray-200")

                // Load the corresponding leaderboard
                const type = this.id.split("-")[0]

                // Add loading animation
                const leaderboardList =
                    document.getElementById("leaderboard-list")
                leaderboardList.classList.add("loading-transition")

                // Load the leaderboard with a slight delay for transition effect
                setTimeout(() => {
                    loadLeaderboard(type)
                    setTimeout(() => {
                        leaderboardList.classList.remove("loading-transition")
                    }, 300)
                }, 100)
            })
        })

        // Load reservation count once
        fetch("/api/reservation_count")
            .then(response => response.json())
            .then(data => {
                document.getElementById("reservationCount").textContent =
                    data.count
            })
            .catch(err =>
                console.error("Error fetching reservation count: ", err)
            )
    })

    const toggleFormBtn = document.getElementById("toggleFormBtn")
    const form = document.getElementById("announcementForm")
    const cancelBtn = document.getElementById("cancelBtn")

    function showForm() {
        form.classList.remove(
            "hidden",
            "opacity-0",
            "translate-y-[-100px]",
            "hover:bg-gray-500/50"
        )
        toggleFormBtn.classList.add("bg-gray-500/50")
        toggleFormBtn.classList.add("hover:bg-gray-500/50")
        toggleFormBtn.textContent = "Close"
    }

    function hideForm() {
        form.classList.add("opacity-0", "translate-y-[-100px]")
        setTimeout(() => {
            form.classList.add("hidden")
        }, 300)
        toggleFormBtn.classList.remove("bg-gray-500/50")
        toggleFormBtn.textContent = "+ Announcement"

        // Reset form
        form.reset()
        form.querySelector('input[name="announcement_id"]').value = ""
    }

    toggleFormBtn.addEventListener("click", () => {
        if (form.classList.contains("hidden")) {
            cancelBtn.classList.add("opacity-0")
            showForm()
        } else {
            cancelBtn.classList.remove("opacity-0")
            hideForm()
        }
    })

    cancelBtn.addEventListener("click", hideForm)

    async function deleteAnnouncement(id) {
        const confirmed = await confirmAction(
            "Are you sure you want to delete this announcement?"
        )
        if (!confirmed) return

        try {
            const response = await fetch(`/announcement/${id}`, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json",
                },
            })

            const data = await response.json()

            if (response.ok) {
                showNotification(
                    data.message || "Announcement deleted successfully",
                    "success"
                )
                setTimeout(() => {
                    window.location.reload()
                }, 3000)
            } else {
                showNotification(
                    data.error || "Failed to delete announcement",
                    "error"
                )
            }
        } catch (error) {
            console.error("Error:", error)
            showNotification(
                "An unexpected error occurred while deleting the announcement",
                "error"
            )
        }
    }

    document.querySelectorAll(".editBtn").forEach(button => {
        button.addEventListener("click", function () {
            const announcementId = this.getAttribute("data-id")
            const announcementCard = this.closest(".bg-white")
            const title = announcementCard
                .querySelector("h2")
                .textContent.trim()
            const content = announcementCard
                .querySelector("p:last-child")
                .textContent.trim()
            showForm()

            // Fill the form with existing data
            const form = document.getElementById("announcementForm")
            form.querySelector('input[name="title"]').value = title
            form.querySelector('textarea[name="content"]').value = content
            form.querySelector('input[name="announcement_id"]').value =
                announcementId
        })
    })

    async function handleFormSubmit(event) {
        event.preventDefault()
        const form = event.target
        const formData = new FormData(form)
        const announcementId = formData.get("announcement_id")

        try {
            let url = "/announcement"
            let method = "POST"

            if (announcementId) {
                url = `/announcement/${announcementId}/edit`
            }

            const response = await fetch(url, {
                method: method,
                body: formData,
            })

            const result = await response.json()
            if (response.ok) {
                showNotification(
                    result.message || "Announcement saved successfully",
                    "success"
                )
                setTimeout(() => window.location.reload(), 5000)
            } else {
                showNotification(
                    result.error || "Failed to save announcement",
                    "error"
                )
            }
        } catch (error) {
            console.error("Error:", error)
            showNotification(
                "An error occurred while saving announcement",
                "error"
            )
        }
    }

    function updateChart() {
        fetch("/statisticchart")
            .then(response => response.json())
            .then(data => {
                const labels = data.map(item =>
                    item.purpose.replace(" programming", "")
                )
                const counts = data.map(item => item.count)

                if (window.myChart) {
                    window.myChart.data.labels = labels
                    window.myChart.data.datasets[0].data = counts
                    window.myChart.update()
                }
            })
            .catch(err =>
                console.error("Error fetching reservation statistics:", err)
            )
    }

    function showReservationStudents() {
        fetch("/api/reservation_students")
            .then(response => response.json())
            .then(data => {
                const studentsList = document.getElementById(
                    "reservationStudentsList"
                )
                studentsList.innerHTML = ""

                data.forEach(student => {
                    const row = document.createElement("tr")
                    row.className = "hover:bg-gray-50"

                    // Format the date
                    const date = new Date(student.date).toLocaleDateString(
                        "en-US",
                        {
                            year: "numeric",
                            month: "long",
                            day: "numeric",
                        }
                    )

                    // Format the time
                    const timeStart = student.time_start // Remove seconds
                    const timeEnd = student.time_end // Remove seconds

                    row.innerHTML = `
                            <td class="px-4 py-3 text-sm text-gray-900">${student.idno}</td>
                            <td class="px-4 py-3 text-sm text-gray-900 uppercase">${student.firstname} ${student.lastname}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">${date}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">${timeStart} - ${timeEnd}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">${student.purpose}</td>
                            <td class="px-4 py-3 text-sm text-gray-600">Lab ${student.labno}</td>
                            <td class="px-4 py-3 text-sm text-center">
                                <button onclick="updateReservationStatus(${student.reservation_id}, 'approved')" 
                                        class="bg-green-500 hover:bg-green-700 text-white px-2 py-1 rounded-lg w-20 transition duration-300">
                                    Approve
                                </button>
                                <button onclick="updateReservationStatus(${student.reservation_id}, 'denied')" 
                                        class="bg-red-500 hover:bg-red-700 text-white px-2 py-1 rounded-lg w-20 transition duration-300">
                                    Deny
                                </button>
                            </td>
                        `
                    studentsList.appendChild(row)
                })

                if (data.length === 0) {
                    const row = document.createElement("tr")
                    row.innerHTML = `
                            <td colspan="6" class="px-4 py-3 text-sm text-gray-600 text-center">
                                No pending reservations found
                            </td>
                        `
                    studentsList.appendChild(row)
                }

                document
                    .getElementById("reservationStudentsModal")
                    .classList.remove("hidden")
            })
    }

    function updateReservationStatus(reservationId, status) {
        fetch(`/api/reservation/${reservationId}/status`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status }),
        })
            .then(response => response.json())
            .then(data => {
                showNotification(data.message, data.status)
                if (data.status === "success") {
                    showReservationStudents()
                }
            })
            .catch(err => {
                console.error("Error updating reservation status:", err)
                showNotification(
                    "An error occurred while updating status",
                    "error"
                )
            })
    }

    function closeModal() {
        document
            .getElementById("reservationStudentsModal")
            .classList.add("hidden")
    }

    function loadLeaderboard(type) {
        const leaderboardList = document.getElementById("leaderboard-list")

        // Show loading state
        leaderboardList.innerHTML = `
            <div class="animate-pulse text-center text-gray-500 py-10">
                <div class="inline-block">
                    <div class="w-4 h-4 bg-blue-500 rounded-full animate-bounce"></div>
                    <div class="w-4 h-4 bg-blue-500 rounded-full animate-bounce200"></div>
                    <div class="w-4 h-4 bg-blue-500 rounded-full animate-bounce400"></div>
                </div>
                <p class="mt-2">Loading leaderboard...</p>
            </div>
        `

        fetch(`/api/leaderboard/${type}`)
            .then(response => response.json())
            .then(data => {
                if (
                    data.status === "success" &&
                    data.data &&
                    data.data.length > 0
                ) {
                    let html = ""

                    // Take only the top 5 students
                    const topFive = data.data.slice(0, 5)

                    topFive.forEach((student, index) => {
                        // Define trophy icons and colors based on ranking
                        let trophyHtml = ""
                        let rankColor = "text-gray-700"
                        let bgColor = ""
                        let animationDelay = index * 150 // Staggered animation delay

                        if (index === 0) {
                            // Gold trophy for 1st place
                            trophyHtml = `
                                <div class="relative">
                                    <div class="absolute -left-1 -top-1.5 w-7 h-7 flex items-center justify-center bg-yellow-500 text-white rounded-full shadow-md border-2 border-white z-10">
                                        <span class="text-xs font-bold">1</span>
                                    </div>
                                    <svg class="w-7 h-7 text-yellow-500 drop-shadow-sm" fill="currentColor" viewBox="0 0 576 512">
                                        <path d="M400 0H176c-26.5 0-48.1 21.8-47.1 48.2c.2 5.3 .4 10.6 .7 15.8H24C10.7 64 0 74.7 0 88c0 92.6 33.5 157 78.5 200.7c44.3 43.1 98.3 64.8 138.1 75.8c23.4 6.5 39.4 26 39.4 45.6c0 20.9-17 37.9-37.9 37.9H192c-17.7 0-32 14.3-32 32s14.3 32 32 32H384c17.7 0 32-14.3 32-32s-14.3-32-32-32H357.9C337 448 320 431 320 410.1c0-19.6 15.9-39.2 39.4-45.6c39.9-11 93.9-32.7 138.2-75.8C542.5 245 576 180.6 576 88c0-13.3-10.7-24-24-24H446.4c.3-5.2 .5-10.4 .7-15.8C448.1 21.8 426.5 0 400 0zM48.9 112h84.4c9.1 90.1 29.2 150.3 51.9 190.6c-24.9-11-50.8-26.5-73.2-48.3c-32-31.1-58-76-63-142.3zM464.1 254.3c-22.4 21.8-48.3 37.3-73.2 48.3c22.7-40.3 42.8-100.5 51.9-190.6h84.4c-5.1 66.3-31.1 111.2-63 142.3z"/>
                                    </svg>
                                </div>
                            `
                            rankColor = "text-yellow-600 font-bold"
                            bgColor =
                                "bg-gradient-to-r from-yellow-50 to-white border-yellow-200"
                        } else if (index === 1) {
                            // Silver trophy for 2nd place
                            trophyHtml = `
                                <div class="relative">
                                    <div class="absolute -left-1 -top-1.5 w-7 h-7 flex items-center justify-center bg-gray-400 text-white rounded-full shadow-md border-2 border-white z-10">
                                        <span class="text-xs font-bold">2</span>
                                    </div>
                                    <svg class="w-7 h-7 text-gray-400 drop-shadow-sm" fill="currentColor" viewBox="0 0 576 512">
                                        <path d="M400 0H176c-26.5 0-48.1 21.8-47.1 48.2c.2 5.3 .4 10.6 .7 15.8H24C10.7 64 0 74.7 0 88c0 92.6 33.5 157 78.5 200.7c44.3 43.1 98.3 64.8 138.1 75.8c23.4 6.5 39.4 26 39.4 45.6c0 20.9-17 37.9-37.9 37.9H192c-17.7 0-32 14.3-32 32s14.3 32 32 32H384c17.7 0 32-14.3 32-32s-14.3-32-32-32H357.9C337 448 320 431 320 410.1c0-19.6 15.9-39.2 39.4-45.6c39.9-11 93.9-32.7 138.2-75.8C542.5 245 576 180.6 576 88c0-13.3-10.7-24-24-24H446.4c.3-5.2 .5-10.4 .7-15.8C448.1 21.8 426.5 0 400 0zM48.9 112h84.4c9.1 90.1 29.2 150.3 51.9 190.6c-24.9-11-50.8-26.5-73.2-48.3c-32-31.1-58-76-63-142.3zM464.1 254.3c-22.4 21.8-48.3 37.3-73.2 48.3c22.7-40.3 42.8-100.5 51.9-190.6h84.4c-5.1 66.3-31.1 111.2-63 142.3z"/>
                                    </svg>
                                </div>
                            `
                            rankColor = "text-gray-600 font-bold"
                            bgColor =
                                "bg-gradient-to-r from-gray-50 to-white border-gray-200"
                        } else if (index === 2) {
                            // Bronze trophy for 3rd place
                            trophyHtml = `
                                <div class="relative">
                                    <div class="absolute -left-1 -top-1.5 w-7 h-7 flex items-center justify-center bg-amber-700 text-white rounded-full shadow-md border-2 border-white z-10">
                                        <span class="text-xs font-bold">3</span>
                                    </div>
                                    <svg class="w-7 h-7 text-amber-700 drop-shadow-sm" fill="currentColor" viewBox="0 0 576 512">
                                        <path d="M400 0H176c-26.5 0-48.1 21.8-47.1 48.2c.2 5.3 .4 10.6 .7 15.8H24C10.7 64 0 74.7 0 88c0 92.6 33.5 157 78.5 200.7c44.3 43.1 98.3 64.8 138.1 75.8c23.4 6.5 39.4 26 39.4 45.6c0 20.9-17 37.9-37.9 37.9H192c-17.7 0-32 14.3-32 32s14.3 32 32 32H384c17.7 0 32-14.3 32-32s-14.3-32-32-32H357.9C337 448 320 431 320 410.1c0-19.6 15.9-39.2 39.4-45.6c39.9-11 93.9-32.7 138.2-75.8C542.5 245 576 180.6 576 88c0-13.3-10.7-24-24-24H446.4c.3-5.2 .5-10.4 .7-15.8C448.1 21.8 426.5 0 400 0zM48.9 112h84.4c9.1 90.1 29.2 150.3 51.9 190.6c-24.9-11-50.8-26.5-73.2-48.3c-32-31.1-58-76-63-142.3zM464.1 254.3c-22.4 21.8-48.3 37.3-73.2 48.3c22.7-40.3 42.8-100.5 51.9-190.6h84.4c-5.1 66.3-31.1 111.2-63 142.3z"/>
                                    </svg>
                                </div>
                            `
                            rankColor = "text-amber-800 font-bold"
                            bgColor =
                                "bg-gradient-to-r from-amber-50 to-white border-amber-200"
                        } else {
                            // No trophy for other rankings
                            trophyHtml = `
                                <div class="w-7 h-7 flex items-center justify-center rounded-full bg-gray-200 text-gray-700 text-xs font-bold shadow-sm">
                                    ${index + 1}
                                </div>
                            `
                            bgColor = "bg-white border-gray-100"
                        }

                        // Determine what value to display based on the leaderboard type
                        let valueToShow = ""
                        let valueLabel = ""
                        let valueColor = ""
                        let valueIcon = ""

                        if (type === "points") {
                            valueToShow = student.points || 0
                            valueLabel = "pts"
                            valueColor = "text-blue-600"
                            valueIcon = `<svg class="w-3.5 h-3.5 text-blue-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                            </svg>`
                        } else if (type === "sitins") {
                            valueToShow = student.total_sitins || 0
                            valueLabel = "sits"
                            valueColor = "text-green-600"
                            valueIcon = `<svg class="w-3.5 h-3.5 text-green-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                            </svg>`
                        } else if (type === "percentage") {
                            valueToShow = student.percentage
                                ? student.percentage.toFixed(1) + "%"
                                : "0%"
                            valueLabel = "rate"
                            valueColor = "text-purple-600"
                            valueIcon = `<svg class="w-3.5 h-3.5 text-purple-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path>
                            </svg>`
                        }

                        html += `
                            <div class="leaderboard-item relative flex items-center justify-between p-3.5 rounded-lg border ${bgColor} hover:shadow-md transition-all duration-300 transform hover:translate-x-1" style="animation-delay: ${animationDelay}ms">
                                <div class="flex items-center space-x-3.5">
                                    <div class="relative flex-shrink-0">
                                        ${trophyHtml}
                                    </div>
                                    <div>
                                        <p class="font-medium text-sm text-gray-800">${student.firstname} ${student.lastname}</p>
                                        <p class="text-xs text-gray-500 flex items-center mt-0.5">
                                            <svg class="w-3 h-3 text-gray-400 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                                            </svg>
                                            ${student.course} - ${student.yr_lvl}
                                        </p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="font-bold text-lg ${rankColor} ${valueColor}">${valueToShow}</p>
                                    <p class="text-xs text-gray-500 flex items-center justify-end mt-0.5">
                                        ${valueIcon}
                                        ${valueLabel}
                                    </p>
                                </div>
                            </div>
                        `
                    })

                    leaderboardList.innerHTML = html

                    // Add animation to items
                    setTimeout(() => {
                        document
                            .querySelectorAll(".leaderboard-item")
                            .forEach(item => {
                                item.classList.add("show")
                            })
                    }, 100)
                } else {
                    leaderboardList.innerHTML = `
                        <div class="flex flex-col items-center justify-center py-10 px-4">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-3">
                                <svg class="w-8 h-8 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <p class="text-gray-500 text-center font-medium">No student data available yet</p>
                            <p class="text-xs text-gray-400 text-center mt-1">Students will appear here when they gain points</p>
                        </div>
                    `
                }
            })
            .catch(err => {
                console.error("Error fetching leaderboard:", err)
                leaderboardList.innerHTML = `
                    <div class="flex flex-col items-center justify-center text-center py-10 px-4">
                        <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mb-3">
                            <svg class="w-8 h-8 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <p class="text-gray-500 font-medium">Failed to load leaderboard</p>
                        <button class="mt-3 px-3 py-1 text-xs text-blue-500 hover:text-blue-700 hover:underline focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-1 rounded-md transition-colors" onclick="loadLeaderboard('${type}')">Try again</button>
                    </div>
                `
            })
    }
</script>

<style>
    /* Overall animations */
    .fade-in {
        animation: fadeIn 0.6s ease-in-out;
    }

    .rise-up {
        animation: riseUp 0.8s ease-out;
    }

    @keyframes fadeIn {
        0% {
            opacity: 0;
        }
        100% {
            opacity: 1;
        }
    }

    @keyframes riseUp {
        0% {
            opacity: 0;
            transform: translateY(20px);
        }
        100% {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Animation for leaderboard items */
    @keyframes slideIn {
        0% {
            opacity: 0;
            transform: translateX(-10px);
        }
        100% {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .animate-item {
        opacity: 0;
        animation: slideIn 0.5s ease-out forwards;
    }

    /* Leaderboard styles */
    .leaderboard-tab.active {
        font-weight: 600;
    }

    #leaderboard-container {
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
            0 2px 4px -1px rgba(0, 0, 0, 0.06);
    }

    #leaderboard-list {
        max-height: 330px;
        scrollbar-width: thin;
        scrollbar-color: rgba(156, 163, 175, 0.3) transparent;
    }

    #leaderboard-list::-webkit-scrollbar {
        width: 4px;
    }

    #leaderboard-list::-webkit-scrollbar-track {
        background: transparent;
    }

    #leaderboard-list::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.3);
        border-radius: 20px;
    }

    /* Leaderboard items animation */
    .leaderboard-item {
        opacity: 0;
        transform: translateX(-10px);
        transition: all 0.3s ease-out;
    }

    .leaderboard-item.show {
        opacity: 1;
        transform: translateX(0);
    }

    /* Enhanced trophy styles */
    .leaderboard-item:hover svg {
        transform: rotate(5deg) scale(1.1);
        transition: transform 0.3s ease;
    }

    /* Top student highlight */
    .leaderboard-item:first-child {
        position: relative;
        overflow: hidden;
    }

    .leaderboard-item:first-child::after {
        content: "";
        position: absolute;
        top: -20px;
        right: -20px;
        width: 40px;
        height: 40px;
        background: rgba(245, 158, 11, 0.2);
        border-radius: 50%;
        z-index: 0;
    }

    /* Tab styling */
    .leaderboard-tab {
        position: relative;
        overflow: hidden;
    }

    .leaderboard-tab::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 50%;
        width: 0;
        height: 2px;
        background-color: currentColor;
        transition: all 0.3s ease;
        transform: translateX(-50%);
    }

    .leaderboard-tab:hover::after {
        width: 80%;
    }

    .leaderboard-tab.active::after {
        width: 100%;
    }

    /* Leaderboard container pulse effect */
    @keyframes subtle-pulse {
        0% {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        50% {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        100% {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1),
                0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
    }

    #leaderboard-container:hover {
        animation: subtle-pulse 2s infinite;
    }

    /* Animation for the loading dots */
    @keyframes bounce200 {
        0%,
        100% {
            transform: translateY(0);
            animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
        }
        50% {
            transform: translateY(-25%);
            animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
        }
    }

    @keyframes bounce400 {
        0%,
        100% {
            transform: translateY(0);
            animation-timing-function: cubic-bezier(0, 0, 0.2, 1);
        }
        50% {
            transform: translateY(-25%);
            animation-timing-function: cubic-bezier(0.8, 0, 1, 1);
        }
    }

    .animate-bounce200 {
        animation: bounce200 1s infinite 0.2s;
    }

    .animate-bounce400 {
        animation: bounce400 1s infinite 0.4s;
    }

    /* Card hover effects */
    #registered-student:hover,
    #current-sitin:hover,
    #reservation-count:hover,
    #total-sitin:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
            0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    #registered-student:hover span,
    #current-sitin:hover span,
    #reservation-count:hover span,
    #total-sitin:hover span {
        transform: scale(1.05);
        transition: transform 0.3s ease;
    }

    /* Responsive adjustments */
    @media (max-width: 1024px) {
        #main-container {
            grid-template-rows: auto;
            height: auto;
        }

        #container-1,
        #container-2 {
            row-span: auto;
        }
    }

    /* Chart container styling */
    #box2 {
        transition: all 0.3s ease;
    }

    #box2:hover {
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
            0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }

    /* Announcement container styling */
    #announcements-container > div:hover {
        border-left-width: 6px;
        transition: all 0.2s ease;
    }

    /* Smooth transitions for all elements */
    * {
        transition-property: background-color, border-color, color, fill, stroke,
            opacity, box-shadow, transform;
        transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        transition-duration: 150ms;
    }

    /* Leaderboard loading transition */
    .loading-transition {
        opacity: 0.6;
        transform: scale(0.98);
        transition: all 0.3s ease;
    }
</style>
{% endblock %}
